option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: backend/main:app
    NumProcesses: 1
    NumThreads: 15
  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: "/var/app/current/backend:$PYTHONPATH"
    ENVIRONMENT: "production"
    TZ: "America/Sao_Paulo"
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
  aws:autoscaling:asg:
    MinSize: 1
    MaxSize: 4
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

packages:
  yum:
    git: []
    postgresql-devel: []
    gcc: []
    python3-devel: []

commands:
  01_migrate:
    command: "cd /var/app/current/backend && python -c 'from database import engine, Base; Base.metadata.create_all(bind=engine)'"
    leader_only: true
  02_collect_static:
    command: "cd /var/app/current/frontend && npm ci && npm run build"
    leader_only: true

files:
  "/etc/httpd/conf.d/ssl_rewrite.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      RewriteEngine On
      <If "-n '%{HTTP:X-Forwarded-Proto}' && %{HTTP:X-Forwarded-Proto} != 'https'">
      RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L]
      </If>

  "/opt/elasticbeanstalk/tasks/taillogs.d/01-app-logs.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/app/current/logs/*.log
      /var/log/eb-engine.log
      /var/log/eb-hooks.log

container_commands:
  01_wsgipass:
    command: 'echo "WSGIPassAuthorization On" >> ../wsgi.conf'
  02_migrate_db:
    command: "cd /var/app/ondeck/backend && python -c 'from database import engine, Base; Base.metadata.create_all(bind=engine)'"
    leader_only: true