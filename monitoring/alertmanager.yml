# =============================================================================
# Configura√ß√£o do Alertmanager - DataClinica
# Gerenciamento e roteamento de alertas
# =============================================================================

global:
  # Configura√ß√µes SMTP para notifica√ß√µes por e-mail
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com}:${SMTP_PORT:-587}'
  smtp_from: '${SMTP_FROM:-alerts@dataclinica.com.br}'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # Configura√ß√µes globais de resolu√ß√£o
  resolve_timeout: 5m
  
  # URLs externas
  http_config:
    tls_config:
      insecure_skip_verify: false
  
  # Configura√ß√µes de template
  templates:
    - '/etc/alertmanager/templates/*.tmpl'

# =============================================================================
# Configura√ß√£o de Rotas
# =============================================================================
route:
  # Configura√ß√µes padr√£o
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'
  
  # Rotas espec√≠ficas
  routes:
    # =============================================================================
    # Alertas Cr√≠ticos - Notifica√ß√£o Imediata
    # =============================================================================
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5m
      repeat_interval: 30m
      routes:
        # Alertas de infraestrutura cr√≠tica
        - match:
            service: database
          receiver: 'database-critical'
          group_wait: 0s
          repeat_interval: 15m
        
        # Alertas de aplica√ß√£o cr√≠tica
        - match:
            service: backend
          receiver: 'backend-critical'
          group_wait: 0s
          repeat_interval: 15m
        
        # Alertas de seguran√ßa
        - match:
            category: security
          receiver: 'security-alerts'
          group_wait: 0s
          repeat_interval: 10m
    
    # =============================================================================
    # Alertas de Warning - Notifica√ß√£o Moderada
    # =============================================================================
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 2h
      routes:
        # Performance warnings
        - match:
            category: performance
          receiver: 'performance-alerts'
          repeat_interval: 1h
        
        # Capacity warnings
        - match:
            category: capacity
          receiver: 'capacity-alerts'
          repeat_interval: 4h
    
    # =============================================================================
    # Alertas de Info - Notifica√ß√£o Baixa Prioridade
    # =============================================================================
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 15m
      group_interval: 30m
      repeat_interval: 24h
    
    # =============================================================================
    # Alertas de Manuten√ß√£o - Silenciados durante janelas de manuten√ß√£o
    # =============================================================================
    - match:
        category: maintenance
      receiver: 'maintenance-alerts'
      group_wait: 30m
      repeat_interval: 6h
    
    # =============================================================================
    # Alertas de Desenvolvimento - Apenas para ambiente dev
    # =============================================================================
    - match:
        environment: development
      receiver: 'dev-alerts'
      group_wait: 10m
      repeat_interval: 4h
    
    # =============================================================================
    # Alertas de Staging - Para ambiente de teste
    # =============================================================================
    - match:
        environment: staging
      receiver: 'staging-alerts'
      group_wait: 5m
      repeat_interval: 2h
    
    # =============================================================================
    # Alertas de Produ√ß√£o - M√°xima prioridade
    # =============================================================================
    - match:
        environment: production
      receiver: 'production-alerts'
      group_wait: 0s
      repeat_interval: 30m

# =============================================================================
# Configura√ß√£o de Receivers
# =============================================================================
receivers:
  # =============================================================================
  # Receiver Padr√£o
  # =============================================================================
  - name: 'default'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-alerts'
        title: 'DataClinica - Alerta Geral'
        text: |
          {{ range .Alerts }}
          *Alerta:* {{ .Annotations.summary }}
          *Descri√ß√£o:* {{ .Annotations.description }}
          *Severidade:* {{ .Labels.severity }}
          *Servi√ßo:* {{ .Labels.service }}
          *Ambiente:* {{ .Labels.environment }}
          *Status:* {{ .Status }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
  
  # =============================================================================
  # Alertas Cr√≠ticos
  # =============================================================================
  - name: 'critical-alerts'
    email_configs:
      - to: '${CRITICAL_EMAIL_LIST:-admin@dataclinica.com.br,devops@dataclinica.com.br}'
        subject: 'üö® CR√çTICO - DataClinica - {{ .GroupLabels.alertname }}'
        body: |
          ALERTA CR√çTICO DETECTADO!
          
          {{ range .Alerts }}
          Alerta: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          Severidade: {{ .Labels.severity }}
          Servi√ßo: {{ .Labels.service }}
          Ambiente: {{ .Labels.environment }}
          Hor√°rio: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          {{ if .Annotations.runbook_url }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          
          {{ if .GeneratorURL }}
          Prometheus: {{ .GeneratorURL }}
          {{ end }}
          {{ end }}
        headers:
          Priority: 'high'
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-critical'
        title: 'üö® CR√çTICO - DataClinica'
        text: |
          <!channel> ALERTA CR√çTICO!
          {{ range .Alerts }}
          *Alerta:* {{ .Annotations.summary }}
          *Descri√ß√£o:* {{ .Annotations.description }}
          *Severidade:* {{ .Labels.severity }}
          *Servi√ßo:* {{ .Labels.service }}
          *Ambiente:* {{ .Labels.environment }}
          {{ if .Annotations.runbook_url }}
          *Runbook:* <{{ .Annotations.runbook_url }}|Procedimentos>
          {{ end }}
          {{ end }}
        send_resolved: true
        color: 'danger'
    
    webhook_configs:
      - url: '${TEAMS_WEBHOOK_URL}'
        send_resolved: true
        http_config:
          basic_auth:
            username: '${TEAMS_USERNAME}'
            password: '${TEAMS_PASSWORD}'
  
  # =============================================================================
  # Alertas de Banco de Dados Cr√≠ticos
  # =============================================================================
  - name: 'database-critical'
    email_configs:
      - to: '${DBA_EMAIL_LIST:-dba@dataclinica.com.br,admin@dataclinica.com.br}'
        subject: 'üî• CR√çTICO DB - DataClinica - {{ .GroupLabels.alertname }}'
        body: |
          PROBLEMA CR√çTICO NO BANCO DE DADOS!
          
          {{ range .Alerts }}
          Alerta: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          Banco: {{ .Labels.database | default "PostgreSQL" }}
          Inst√¢ncia: {{ .Labels.instance }}
          Hor√°rio: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          A√á√ÉO IMEDIATA NECESS√ÅRIA!
          {{ end }}
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-database'
        title: 'üî• CR√çTICO - Banco de Dados'
        text: |
          <!channel> PROBLEMA CR√çTICO NO BANCO!
          {{ range .Alerts }}
          *Alerta:* {{ .Annotations.summary }}
          *Banco:* {{ .Labels.database | default "PostgreSQL" }}
          *Inst√¢ncia:* {{ .Labels.instance }}
          {{ end }}
        color: 'danger'
  
  # =============================================================================
  # Alertas de Backend Cr√≠ticos
  # =============================================================================
  - name: 'backend-critical'
    email_configs:
      - to: '${DEV_EMAIL_LIST:-dev@dataclinica.com.br,admin@dataclinica.com.br}'
        subject: '‚ö†Ô∏è CR√çTICO API - DataClinica - {{ .GroupLabels.alertname }}'
        body: |
          PROBLEMA CR√çTICO NA API!
          
          {{ range .Alerts }}
          Alerta: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          Endpoint: {{ .Labels.endpoint | default "N/A" }}
          M√©todo: {{ .Labels.method | default "N/A" }}
          Status Code: {{ .Labels.status_code | default "N/A" }}
          Hor√°rio: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-backend'
        title: '‚ö†Ô∏è CR√çTICO - API Backend'
        text: |
          <!here> PROBLEMA CR√çTICO NA API!
          {{ range .Alerts }}
          *Alerta:* {{ .Annotations.summary }}
          *Endpoint:* {{ .Labels.endpoint | default "N/A" }}
          *M√©todo:* {{ .Labels.method | default "N/A" }}
          {{ end }}
        color: 'danger'
  
  # =============================================================================
  # Alertas de Seguran√ßa
  # =============================================================================
  - name: 'security-alerts'
    email_configs:
      - to: '${SECURITY_EMAIL_LIST:-security@dataclinica.com.br,admin@dataclinica.com.br}'
        subject: 'üõ°Ô∏è SEGURAN√áA - DataClinica - {{ .GroupLabels.alertname }}'
        body: |
          ALERTA DE SEGURAN√áA DETECTADO!
          
          {{ range .Alerts }}
          Alerta: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          Tipo: {{ .Labels.attack_type | default "Desconhecido" }}
          IP Origem: {{ .Labels.source_ip | default "N/A" }}
          Hor√°rio: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          INVESTIGA√á√ÉO IMEDIATA NECESS√ÅRIA!
          {{ end }}
        headers:
          Priority: 'urgent'
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-security'
        title: 'üõ°Ô∏è ALERTA DE SEGURAN√áA'
        text: |
          <!channel> ALERTA DE SEGURAN√áA!
          {{ range .Alerts }}
          *Alerta:* {{ .Annotations.summary }}
          *Tipo:* {{ .Labels.attack_type | default "Desconhecido" }}
          *IP:* {{ .Labels.source_ip | default "N/A" }}
          {{ end }}
        color: 'warning'
  
  # =============================================================================
  # Alertas de Warning
  # =============================================================================
  - name: 'warning-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-warnings'
        title: '‚ö†Ô∏è Warning - DataClinica'
        text: |
          {{ range .Alerts }}
          *Alerta:* {{ .Annotations.summary }}
          *Descri√ß√£o:* {{ .Annotations.description }}
          *Servi√ßo:* {{ .Labels.service }}
          {{ end }}
        send_resolved: true
        color: 'warning'
  
  # =============================================================================
  # Alertas de Performance
  # =============================================================================
  - name: 'performance-alerts'
    email_configs:
      - to: '${PERFORMANCE_EMAIL_LIST:-performance@dataclinica.com.br}'
        subject: 'üìä Performance - DataClinica - {{ .GroupLabels.alertname }}'
        body: |
          Alerta de Performance Detectado
          
          {{ range .Alerts }}
          Alerta: {{ .Annotations.summary }}
          M√©trica: {{ .Labels.metric_name | default "N/A" }}
          Valor Atual: {{ .Labels.current_value | default "N/A" }}
          Threshold: {{ .Labels.threshold | default "N/A" }}
          Servi√ßo: {{ .Labels.service }}
          {{ end }}
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-performance'
        title: 'üìä Performance Alert'
        text: |
          {{ range .Alerts }}
          *M√©trica:* {{ .Labels.metric_name | default "N/A" }}
          *Valor:* {{ .Labels.current_value | default "N/A" }}
          *Limite:* {{ .Labels.threshold | default "N/A" }}
          {{ end }}
        color: 'warning'
  
  # =============================================================================
  # Alertas de Capacidade
  # =============================================================================
  - name: 'capacity-alerts'
    email_configs:
      - to: '${CAPACITY_EMAIL_LIST:-ops@dataclinica.com.br}'
        subject: 'üíæ Capacidade - DataClinica - {{ .GroupLabels.alertname }}'
        body: |
          Alerta de Capacidade
          
          {{ range .Alerts }}
          Recurso: {{ .Labels.resource | default "N/A" }}
          Uso Atual: {{ .Labels.usage_percent | default "N/A" }}%
          Limite: {{ .Labels.threshold | default "N/A" }}%
          Servi√ßo: {{ .Labels.service }}
          {{ end }}
  
  # =============================================================================
  # Alertas de Info
  # =============================================================================
  - name: 'info-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-info'
        title: '‚ÑπÔ∏è Info - DataClinica'
        text: |
          {{ range .Alerts }}
          *Info:* {{ .Annotations.summary }}
          *Servi√ßo:* {{ .Labels.service }}
          {{ end }}
        send_resolved: true
        color: 'good'
  
  # =============================================================================
  # Alertas de Manuten√ß√£o
  # =============================================================================
  - name: 'maintenance-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-maintenance'
        title: 'üîß Manuten√ß√£o - DataClinica'
        text: |
          {{ range .Alerts }}
          *Manuten√ß√£o:* {{ .Annotations.summary }}
          *Servi√ßo:* {{ .Labels.service }}
          {{ end }}
        color: '#439FE0'
  
  # =============================================================================
  # Alertas de Desenvolvimento
  # =============================================================================
  - name: 'dev-alerts'
    slack_configs:
      - api_url: '${SLACK_DEV_WEBHOOK_URL:-${SLACK_WEBHOOK_URL}}'
        channel: '#dataclinica-dev'
        title: 'üî® Dev - DataClinica'
        text: |
          {{ range .Alerts }}
          *Dev Alert:* {{ .Annotations.summary }}
          *Servi√ßo:* {{ .Labels.service }}
          {{ end }}
        color: '#36a64f'
  
  # =============================================================================
  # Alertas de Staging
  # =============================================================================
  - name: 'staging-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-staging'
        title: 'üß™ Staging - DataClinica'
        text: |
          {{ range .Alerts }}
          *Staging Alert:* {{ .Annotations.summary }}
          *Servi√ßo:* {{ .Labels.service }}
          {{ end }}
        color: '#ff9900'
  
  # =============================================================================
  # Alertas de Produ√ß√£o
  # =============================================================================
  - name: 'production-alerts'
    email_configs:
      - to: '${PRODUCTION_EMAIL_LIST:-admin@dataclinica.com.br,ops@dataclinica.com.br}'
        subject: 'üöÄ PRODU√á√ÉO - DataClinica - {{ .GroupLabels.alertname }}'
        body: |
          ALERTA DE PRODU√á√ÉO!
          
          {{ range .Alerts }}
          Alerta: {{ .Annotations.summary }}
          Descri√ß√£o: {{ .Annotations.description }}
          Severidade: {{ .Labels.severity }}
          Servi√ßo: {{ .Labels.service }}
          Hor√°rio: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        headers:
          Priority: 'high'
    
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#dataclinica-production'
        title: 'üöÄ PRODU√á√ÉO - DataClinica'
        text: |
          <!here> ALERTA DE PRODU√á√ÉO!
          {{ range .Alerts }}
          *Alerta:* {{ .Annotations.summary }}
          *Severidade:* {{ .Labels.severity }}
          *Servi√ßo:* {{ .Labels.service }}
          {{ end }}
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

# =============================================================================
# Configura√ß√µes de Inibi√ß√£o
# =============================================================================
inhibit_rules:
  # Inibir alertas de warning quando h√° alertas cr√≠ticos do mesmo servi√ßo
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'instance']
  
  # Inibir alertas de info quando h√° alertas de warning do mesmo servi√ßo
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['service', 'instance']
  
  # Inibir alertas de inst√¢ncia quando o servi√ßo inteiro est√° down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*Instance.*'
    equal: ['service']
  
  # Inibir alertas de conectividade quando h√° problemas de rede
  - source_match:
      category: 'network'
    target_match:
      category: 'connectivity'
    equal: ['instance']

# =============================================================================
# Configura√ß√µes de Templates
# =============================================================================
templates:
  - '/etc/alertmanager/templates/default.tmpl'
  - '/etc/alertmanager/templates/slack.tmpl'
  - '/etc/alertmanager/templates/email.tmpl'

# =============================================================================
# Configura√ß√µes de Tempo
# =============================================================================
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'America/Sao_Paulo'
  
  - name: 'weekend'
    time_intervals:
      - weekdays: ['saturday', 'sunday']
        location: 'America/Sao_Paulo'
  
  - name: 'maintenance-window'
    time_intervals:
      - times:
          - start_time: '02:00'
            end_time: '04:00'
        weekdays: ['sunday']
        location: 'America/Sao_Paulo'

# =============================================================================
# Configura√ß√µes de Mute
# =============================================================================
mute_time_intervals:
  - name: 'maintenance-mute'
    time_intervals:
      - 'maintenance-window'

# =============================================================================
# Configura√ß√µes de Cluster (para HA)
# =============================================================================
# cluster:
#   listen-address: "0.0.0.0:9094"
#   peer: ["alertmanager-1:9094", "alertmanager-2:9094"]
#   gossip-interval: "200ms"
#   pushpull-interval: "60s"

# =============================================================================
# Configura√ß√µes de API
# =============================================================================
api:
  v2:
    cors:
      allowed_origins: ["*"]
      allowed_methods: ["GET", "POST", "PUT", "DELETE"]
      allowed_headers: ["*"]

# =============================================================================
# Configura√ß√µes de Log
# =============================================================================
log:
  level: info
  format: json